<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNPUN OS v10 - Zero Overlap</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://script.google.com/macros/s/AKfycbx2V3h_nDERIEj4_8FK27e8b2ISvbR1hLuvcZnNKEBRwlRt38QVuuMd4dmuVzSUT3E/exec"></script>

  <style>
    :root { --accent: #000; --panel-bg: #f8f9fa; }
    body { font-family: 'Inter', 'Sarabun', sans-serif; background: #dfe4e8; margin: 0; display: flex; height: 100vh; overflow: hidden; }

    .sidebar { width: 550px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: 10px 0 30px rgba(0,0,0,0.05); }
    .scroll-area { flex: 1; overflow-y: auto; padding: 20px; background: var(--panel-bg); }

    .section-box { background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
    .section-title { font-weight: 900; font-size: 0.85em; text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom: 8px; }

    .item-row { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
    .item-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .item-pct { width: 78px; text-align: center; font-weight: bold; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

    /* --- Sub-groups (C1/C2, D1/D2/D3, E1/E2, F1-F6) --- */
    .group-legend { font-size: 0.78em; color:#444; margin: 6px 0 10px; line-height: 1.35; }
    .group-legend .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin: 2px 6px 2px 0; background:#fafafa; font-weight:700; }
    .subgroup { margin-top: 8px; border-top: 1px dashed #e3e3e3; padding-top: 8px; }
    .subgroup:first-child { margin-top: 0; border-top: none; padding-top: 0; }
    .subgroup-head { font-size: 0.78em; font-weight: 900; color:#111; text-transform: uppercase; letter-spacing: 0.4px; margin: 4px 0 6px; display:flex; align-items: baseline; gap: 8px; }
    .subgroup-head small { font-size: 0.95em; font-weight: 700; color:#666; text-transform: none; letter-spacing: 0; }

    .part-warning { font-size: 0.78em; margin-top: 8px; padding: 8px 10px; border-radius: 8px; display:none; }
    .part-warning.over { display:block; background:#ffe7e7; color:#b00020; border:1px solid #ffb3b3; }
    .part-warning.under { display:block; background:#fff6d6; color:#7a5a00; border:1px solid #ffe29a; }

    .qs-btn { font-weight: 900; font-size: 0.78em; border: 1px solid #111; background: #fff; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .qs-btn:hover { background:#f3f3f3; }
    .qs-btn:active { transform: translateY(1px); }

    /* --- Preview --- */
    .preview-pane { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }

    #label-area {
      width: 50mm; height: 100mm; background: white; padding: 4mm 4.5mm; box-sizing: border-box;
      position: relative; color: black; box-shadow: 0 30px 60px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; overflow: hidden;
    }

    .lbl-header {
      min-height: 12mm;
      height: auto;
      border-bottom: 2.5px solid black;
      margin-bottom: 2mm;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 2mm;
      padding-bottom: 1mm;
    }
    .lbl-left {
      display: flex;
      align-items: flex-start;
      gap: 2mm;
      min-width: 0;
    }
    .lbl-logo {
      height: 10mm;
      width: auto;
      object-fit: contain;
      display: block;
      flex: 0 0 auto;
    }
    .lbl-left-text {
      min-width: 0;
    }
    .lbl-brand { font-weight: 900; font-size: 14pt; line-height: 0.9; }
    .lbl-sub { font-size: 5.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

    .lbl-title-box { height: 15mm; display: flex; align-items: center; justify-content: center; text-align: center; border-bottom: 1px solid black; margin-bottom: 2mm; }
    .lbl-title { font-weight: 900; font-size: 10pt; line-height: 1.1; text-transform: uppercase; }

    .lbl-section-h { font-weight: 900; font-size: 6.5pt; text-transform: uppercase; margin-bottom: 1.5mm; }
    .lbl-hero-list { flex: 1; overflow: hidden; font-size: 7.2pt; font-weight: 700; line-height: 1.25; }
    .lbl-hero-item { display: flex; justify-content: space-between; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .lbl-footer-fixed { border-top: 1.5px solid black; padding-top: 1.5mm; background: white; z-index: 10; }
    .lbl-meta-row { display: flex; justify-content: space-between; font-size: 6pt; font-family: 'Sarabun'; margin-bottom: 1mm; }
    .lbl-meta-row b { font-family: 'Inter'; }

    .lbl-allergy { font-size: 4.8pt; font-weight: 900; text-transform: uppercase; border-top: 0.5px solid #ddd; padding-top: 1mm; margin-bottom: 0.5mm; }
    .lbl-inci {
      font-size: 4pt;
      line-height: 1.05;
      letter-spacing: -0.10px;
      text-align: left !important;
      text-justify: none;
      word-spacing: normal;
      height: 14mm;
      overflow: hidden;
      color: #222;
      white-space: normal;
      word-break: normal;
      overflow-wrap: break-word;
      hyphens: none;
    }

    .qr-canvas {
      width: 10mm;
      height: 10mm;
      flex: 0 0 auto;
    }
    .lbl-warning { text-align: center; font-weight: 900; font-size: 7pt; border: 1.2px solid black; padding: 1px; margin-top: 1.5mm; text-transform: uppercase; }

    .cost-bar { background: #000; color: white; padding: 20px; display: flex; gap: 10px; justify-content: space-between; align-items: center; }

    @media print {
      .sidebar, .cost-bar, .mobile-bar { display: none; }
      #label-area { position: fixed; top: 0; left: 0; border: none; box-shadow: none; transform: none !important; }
      @page { size: 50mm 100mm; margin: 0; }
    }

    /* --- Mobile support (phone-friendly) --- */
    .mobile-bar { display:none; }
    .mobile-bar button{
      flex:1;
      padding:12px 10px;
      border:none;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      border-radius:10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .mobile-bar button.active{
      background:#111;
      color:#fff;
    }

    /* Default desktop layout stays the same. On mobile we switch to stacked + tabs */
    @media (max-width: 900px) {
      body{
        flex-direction: column;
        height: auto;
        overflow: auto; /* allow scrolling on phone */
      }

      .mobile-bar{
        display:flex;
        gap:10px;
        padding:12px;
        background:#dfe4e8;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .sidebar{
        width: 100%;
        border-right: none;
        box-shadow: none;
        height: auto;
      }

      /* iOS Safari fix: don't trap content in a flex+overflow scroll container */
      .scroll-area{
        padding: 12px;
        flex: none;
        overflow: visible;
        max-height: none;
      }

      .preview-pane{
        width: 100%;
        padding: 12px;
      }

      #label-area{
        transform: scale(0.92);
        transform-origin: top center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.18);
      }

      /* Tab behavior driven by body data-view */
      body[data-view="builder"] .preview-pane{ display:none; }
      body[data-view="preview"] .sidebar{ display:none; }

      /* Cost bar sticky bottom on phones */
      .cost-bar{
        padding: 12px;
        gap: 8px;
        flex-wrap: wrap;
        position: sticky;
        bottom: 0;
        z-index: 999;
      }
      .cost-bar button{ flex: 1 1 auto; }
    }
  </style>
</head>
<body>

  <!-- Mobile tabs (shown only on small screens) -->
  <div class="mobile-bar">
    <button id="btnBuilder" class="active" onclick="showView('builder')">โหมดทำสูตร</button>
    <button id="btnPreview" onclick="showView('preview')">โหมดฉลาก</button>
  </div>

  <div class="sidebar">
    <div class="sidebar-header" style="padding:20px; border-bottom: 2px solid #000;">
      <h2 style="margin:0; font-weight:900;">UNPUN INDUSTRIAL</h2>
      <div style="font-size:0.8em; color:#666">Version 10.0 | Fixed Layout Engine</div>
    </div>

    <div class="scroll-area">
      <div class="section-box">
        <label style="font-weight:900; font-size:0.85em;">DEVELOPER NAME:</label>
        <input type="text" id="custName" value="K.Somchai" oninput="updateAll()"
               style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" />
      </div>

      <div class="section-box">
        <div style="font-weight:900; font-size:0.85em; text-transform:uppercase;">Customer Contact</div>
        <div style="font-size:0.8em; color:#666; margin-top:4px; line-height:1.35;">
          กรอกข้อมูลลูกค้า แล้วกดบันทึกเพื่อส่งไปหลังบ้าน (Google Sheet / API)
        </div>

        <div style="margin-top:10px; display:grid; gap:10px;">
          <div>
            <label style="font-weight:900; font-size:0.8em;">PHONE</label>
            <input type="tel" id="custPhone" placeholder="เช่น 08x-xxx-xxxx"
                   style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-weight:900; font-size:0.8em;">LINE</label>
            <input type="text" id="custLine" placeholder="Line ID"
                   style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-weight:900; font-size:0.8em;">EMAIL</label>
            <input type="email" id="custEmail" placeholder="name@email.com"
                   style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" />
          </div>

          <button id="btnSaveLead" onclick="submitLeadToBackend()"
                  style="padding:12px 14px; font-weight:900; cursor:pointer; background:#111; color:#fff; border:none; border-radius:10px; box-shadow: 0 6px 14px rgba(0,0,0,0.18);">
            SAVE CUSTOMER + FORMULA
          </button>
          <div id="saveStatus" style="font-size:0.8em; color:#666;"></div>
        </div>
      </div>

      <div class="section-box">
        <label style="font-weight:900; font-size:0.85em;">FORMULA POOL:</label>
        <select id="selPool" onchange="renderInterface(); applyPoolConfig(); updateAll();"
                style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px;"></select>
      </div>

      <div id="ingredient-lists"></div>
    </div>

    <div class="cost-bar">
      <div>
        <small style="color:#aaa">EST. COST/KG</small><br />
        <strong id="totalCost" style="font-size:1.6em">0</strong> THB
      </div>

      <button onclick="qsTo100()"
              style="padding:12px 18px; font-weight:900; cursor:pointer; background:#fff; border:none; border-radius:6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
        QS → 100%
      </button>

      <button onclick="window.print()"
              style="padding:12px 24px; font-weight:900; cursor:pointer; background:#fff; border:none; border-radius:6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
        PRINT LABEL
      </button>
    </div>
  </div>

  <div class="preview-pane">
    <div id="label-area">
      <div class="lbl-header">
        <div class="lbl-left">
          <img src="logo_unpun.png" alt="UNPUN Logo" class="lbl-logo" />
          <div class="lbl-left-text">
          </div>
        </div>
        <canvas id="qr" class="qr-canvas"></canvas>
      </div>

      <div class="lbl-title-box">
        <div class="lbl-title" id="lblTitle">PRODUCT NAME</div>
      </div>

      <div class="lbl-section-h">Includes</div>
      <div class="lbl-hero-list" id="lblHero"></div>

      <div class="lbl-footer-fixed">
        <div class="lbl-meta-row">
          <span>DEV: <b id="lblDev">...</b></span>
          <span>COST: <b id="lblCostVal">0</b></span>
        </div>
        <div class="lbl-meta-row">
          <span>BATCH: <b id="lblBatch">#UB-001</b></span>
          <span>NET: <b>50 ML.</b></span>
        </div>
        <div id="lblAllergy" class="lbl-allergy">*Allergens: -</div>
        <div class="lbl-inci" id="lblInci">Ingredients: ...</div>
        <div class="lbl-warning">Sample - Not For Sale</div>
      </div>
    </div>
  </div>

<script>
// ======================
// BACKEND (placeholder)
// ใส่ URL จาก Google Apps Script Web App (หรือ API ของคุณ) ตรงนี้
// ======================
const BACKEND_ENDPOINT = "https://script.google.com/macros/s/AKfycbx2V3h_nDERIEj4_8FK27e8b2ISvbR1hLuvcZnNKEBRwlRt38QVuuMd4dmuVzSUT3E/exec"; // e.g. "https://script.google.com/macros/s/XXXX/exec"

function setSaveStatus(msg, ok=true){
  const el = document.getElementById('saveStatus');
  if(!el) return;
  el.style.color = ok ? '#0a6' : '#b00020';
  el.textContent = msg;
}

// Export สูตรปัจจุบันเป็น JSON (ไว้ส่งไปหลังบ้าน)
function exportCurrentFormula() {
  const poolKey = document.getElementById('selPool')?.value || "";
  const poolName = POOLS?.[poolKey]?.name || "";

  const items = [];
  MASTER_DB.forEach((it, idx) => {
    const chk = document.getElementById(`chk-${idx}`);
    const pctEl = document.getElementById(`pct-${idx}`);

    const isChecked = (chk?.checked) || it.p === 'G';
    if (!isChecked) return;

    const raw = parseFloat(pctEl?.value);
    // Part G fixed
    const gFixedVal = (it.p === 'G')
      ? (it.n === 'BHT' ? fixedG.BHT : (it.n === 'Vit E' ? fixedG.TocopherylAcetate : 0))
      : 0;

    const val = Number.isFinite(raw) ? raw : gFixedVal;
    if (!(val > 0)) return;

    items.push({
      part: it.p,
      grp: it.grp || "",
      name: it.n,
      inci: it.i || "",
      pct: Number(Number(val).toFixed(2)),
      costPerKg: it.c
    });
  });

  return {
    poolKey,
    poolName,
    createdAt: new Date().toISOString(),
    items
  };
}

// ส่งข้อมูลลูกค้า + สูตร ไปหลังบ้าน
async function submitLeadToBackend() {
  const btn = document.getElementById('btnSaveLead');
  if (btn) btn.disabled = true;
  setSaveStatus('กำลังบันทึก...', true);

  if (!BACKEND_ENDPOINT) {
    setSaveStatus('ยังไม่ได้ใส่ BACKEND_ENDPOINT (ไปใส่ URL จาก Google Apps Script ก่อน)', false);
    if (btn) btn.disabled = false;
    return;
  }

  const payload = {
    name: document.getElementById('custName')?.value || "",
    phone: document.getElementById('custPhone')?.value || "",
    line: document.getElementById('custLine')?.value || "",
    email: document.getElementById('custEmail')?.value || "",
    totalCost: document.getElementById('totalCost')?.innerText || "",
    formula: exportCurrentFormula()
  };

  // IMPORTANT:
  // Google Apps Script Web App มักเจอปัญหา CORS/Preflight ถ้าส่งเป็น application/json
  // ดังนั้นเราส่งเป็น x-www-form-urlencoded เพื่อลดโอกาส "Load failed"
  const formBody = new URLSearchParams({
    payload: JSON.stringify(payload)
  });

  try {
    const res = await fetch(BACKEND_ENDPOINT, {
      method: 'POST',
      body: formBody,
      redirect: 'follow',
      cache: 'no-store'
    });

    // Apps Script บางครั้งตอบกลับเป็น text/html หรือ text/plain
    const text = await res.text().catch(() => "");

    let out = {};
    try {
      out = text ? JSON.parse(text) : {};
    } catch (_) {
      out = { ok: res.ok, raw: text };
    }

    if (res.ok && (out.ok === true || out.success === true || out.status === 'ok' || text === '' || text === 'OK')) {
      setSaveStatus('บันทึกแล้ว ✔', true);
    } else {
      setSaveStatus('บันทึกไม่สำเร็จ: ' + (out?.error || out?.message || 'เช็ค Apps Script / Permission / Response'), false);
    }
  } catch (err) {
    // "TypeError: Failed to fetch" / "Load failed" มักมาจาก CORS/Preflight/Redirect/Permission
    setSaveStatus('ส่งไม่สำเร็จ: ' + (err?.message || err), false);
  } finally {
    if (btn) btn.disabled = false;
  }
}
// --- 1) DATA MASTER ---
let POOLS = {
  "PARFUME_MAX": { name: "Parfume Body Oil",     ratios: { A:45, B:35, C:5,  D:2,  E:0.8, F:12,  G:0.5 } },
  "GLOW_DEW":    { name: "Glow & Dew Body Oil", ratios: { A:38, B:28, C:25, D:2,  E:4,   F:2.8, G:0.5 } },
  "DRY_TOUCH":   { name: "Dry Touch Oil",       ratios: { A:25, B:55, C:15, D:2,  E:0.5, F:2.3, G:0.5 } },
  "THERAPY":     { name: "Therapy Body Oil",    ratios: { A:35, B:25, C:32, D:2,  E:0.3, F:5.5, G:0.5 } },
  "SUN_OIL":     { name: "Sunscreen Oil",       ratios: { A:35, B:30, C:18, D:12, E:0.5, F:4.3, G:0.5 } }
};

const MASTER_DB = [
  {p:"A", n:"Light White Oil", i:"Paraffinum Liquidum", c:2.0},
  {p:"A", n:"Medium White Oil", i:"Paraffinum Liquidum", c:52.0},
  {p:"A", n:"Rice Bran Oil (Refine)", i:"Oryza Sativa (Rice) Bran Oil", c:47.08},
  {p:"A", n:"Sunflower Oil (Refine)", i:"Helianthus Annuus (Sunflower) Seed Oil", c:246.2},
  {p:"A", n:"Soybean Oil (Refine)", i:"Glycine Soja (Soybean) Oil", c:203.0},
  {p:"A", n:"MCT Oil", i:"Caprylic/Capric Triglyceride", c:920.0},

  {p:"B", n:"IPM", i:"Isopropyl Myristate", c:145.0},
  {p:"B", n:"C12-15 Alkyl Benzoate", i:"C12-15 Alkyl Benzoate", c:1357.0},
  {p:"B", n:"Ethylhexyl Palmitate", i:"Ethylhexyl Palmitate", c:110.0},
  {p:"B", n:"Triethyl Citrate", i:"Triethyl Citrate", c:120.0},
  {p:"B", n:"Isoamyl Laurate", i:"Isoamyl Laurate", c:690.0},

  {p:"C", grp:"C1", n:"Rosehip Oil", i:"Rosa Canina Seed Oil", c:97.37, k:"Radiant Repair", note:"ลดรอย/แผลเป็น"},
  {p:"C", grp:"C1", n:"Seabuckthorn Oil", i:"Hippophae Rhamnoides Fruit Oil", c:62.0, k:"Vita-C Glow", note:"Vit C สูง/ผิวใส"},
  {p:"C", grp:"C1", n:"Passion Fruit Oil", i:"Passiflora Edulis Seed Oil", c:121.0, k:"Brightening Touch", note:"Vit C/เนื้อเบา"},
  {p:"C", grp:"C1", n:"Grapeseed Oil", i:"Vitis Vinifera (Grape) Seed Oil", c:124.12, k:"Antioxidant Shield", note:"ต้านอนุมูลอิสระ"},
  {p:"C", grp:"C1", n:"Lemon Oil", i:"Citrus Limon (Lemon) Peel Oil", c:85.0, k:"Clarifying", note:"ผลัดผิวใส"},

  {p:"C", grp:"C2", n:"Argan Oil", i:"Argania Spinosa Kernel Oil", c:555.0, k:"Deep Nourishing", note:"บำรุงลึก/ผม+ผิว"},
  {p:"C", grp:"C2", n:"Avocado Oil", i:"Persea Gratissima (Avocado) Oil", c:45.0, k:"Rich Moisture", note:"ผิวแห้ง/Vit E"},
  {p:"C", grp:"C2", n:"Jojoba Oil", i:"Simmondsia Chinensis (Jojoba) Seed Oil", c:1004.0, k:"Skin Balancing", note:"ปรับสมดุลผิว"},
  {p:"C", grp:"C2", n:"Olive Oil", i:"Olea Europaea (Olive) Fruit Oil", c:260.0, k:"Intense Hydration", note:"ชุ่มชื้นสูง"},
  {p:"C", grp:"C2", n:"Wheat Germ Oil", i:"Triticum Vulgare (Wheat) Germ Oil", c:695.0, k:"Skin Recovery", note:"ฟื้นฟูผิวเสีย"},

  {p:"D", grp:"D1", n:"Vitamin C", i:"Ascorbyl Tetraisopalmitate", c:3995.0, k:"Ultimate Brightening", note:"ผิวขาว/ซึมไว"},
  {p:"D", grp:"D1", n:"Vitamin C Enzymes", i:"Ascorbyl Palmitate", c:1895.0, k:"Glow Booster", note:"ผิวใสมาตรฐาน"},
  {p:"D", grp:"D1", n:"Bisabolol", i:"Bisabolol", c:4195.0, k:"Soothing Care", note:"ลดแพ้/ระคายเคือง"},
  {p:"D", grp:"D1", n:"Salicylic Acid (BHA)", i:"Salicylic Acid", c:4995.0, k:"Clear Skin", note:"ลดสิว/อุดตัน"},
  {p:"D", grp:"D1", n:"Tomato Extract", i:"Solanum Lycopersicum (Tomato) Fruit Extract", c:445.0, k:"Healthy Glow", note:"ผิวอมชมพู"},

  {p:"D", grp:"D2", n:"Vitamin A (Retinyl)", i:"Retinyl Palmitate", c:645.0, k:"Age Defense", note:"ลดริ้วรอย"},
  {p:"D", grp:"D2", n:"Coenzyme Q10", i:"Ubiquinone", c:1995.0, k:"Skin Energizing", note:"พลังงานผิว"},
  {p:"D", grp:"D2", n:"Vitamin K1", i:"Phytonadione", c:145.0, k:"Correcting", note:"ลดรอยช้ำ"},
  {p:"D", grp:"D2", n:"Bakuchiol", i:"Bakuchiol", c:410.0, k:"Gentle Renewal", note:"เรตินอลธรรมชาติ"},
  {p:"D", grp:"D2", n:"Ceramide Complex", i:"Ceramide NP", c:650.0, k:"Barrier Support", note:"เสริมชั้นผิว"},

  // D3: UV Filters (for Sunscreen Oil)
  {p:"D", grp:"D3", n:"OMC (Octinoxate)", i:"Ethylhexyl Methoxycinnamate", c:1395.0, k:"UVB Defense", note:"กัน UVB/ผิวไหม้"},
  {p:"D", grp:"D3", n:"Octocrylene", i:"Octocrylene", c:2585.0, k:"Active Shield", note:"กันน้ำ/เสริมเสถียร"},
  {p:"D", grp:"D3", n:"Avobenzone", i:"Butyl Methoxydibenzoylmethane", c:412.0, k:"UVA Protection", note:"กัน UVA/ริ้วรอย"},
  {p:"D", grp:"D3", n:"Homosalate", i:"Homosalate", c:120.0, k:"Solar Absorb", note:"ช่วยละลายกันแดด"},
  {p:"D", grp:"D3", n:"Octisalate", i:"Ethylhexyl Salicylate", c:1495.0, k:"UV Booster", note:"เสริมกันแดด UVB"},

  {p:"E", grp:"E1", n:"Sparkling Gold", i:"Mica, Titanium Dioxide, Iron Oxides", c:260.0, k:"Holographic Shine", note:"วิ้งทองหรูหรา"},
  {p:"E", grp:"E1", n:"Rich Bronze", i:"Mica, Iron Oxides", c:1498.0, k:"Golden Glow", note:"ผิวแทนบ่มแดด"},
  {p:"E", grp:"E1", n:"Pearl White", i:"Mica, Titanium Dioxide", c:1860.0, k:"Sunkissed Bronze", note:"วิ้งมุกมีออร่า"},
  {p:"E", grp:"E1", n:"Rose Gold", i:"Mica, Titanium Dioxide, Iron Oxides", c:1544.0, k:"Pearlescent", note:"ทองอมชมพู"},
  {p:"E", grp:"E1", n:"Holographic Blue", i:"Mica, Titanium Dioxide, Tin Oxide", c:2665.0, k:"Rosy Radiance", note:"เหลือบมิติฟ้า"},

  {p:"E", grp:"E2", n:"Sunset Yellow", i:"CI 15985 (Yellow 6 Lake)", c:2890.0, k:"Warm Amber", note:"เหลืองอำพัน"},
  {p:"E", grp:"E2", n:"Ocean Blue", i:"CI 42090 (Blue 1 Lake)", c:484.0, k:"Oceanic Tint", note:"ฟ้ามหาสมุทร"},
  {p:"E", grp:"E2", n:"Cherry Red", i:"CI 26100 (Red 17) หรือ CI 15850 (Red 7 Lake)", c:855.0, k:"Cherry Glaze", note:"แดงเชอร์รี่"},
  {p:"E", grp:"E2", n:"Violet", i:"CI 60725 (Violet 2)", c:69.0, k:"Violet Haze", note:"ม่วงลาเวนเดอร์"},
  {p:"E", grp:"E2", n:"Emerald Green", i:"CI 61565 (Green 6)", c:1016.5, k:"Emerald Essence", note:"เขียวมรกต"},

  {p:"F", grp:"F1", n:"Rose", i:"Parfum", c:802.5},
  {p:"F", grp:"F1", n:"Jasmine", i:"Parfum", c:1872.5},
  {p:"F", grp:"F1", n:"Lavender", i:"Parfum", c:107.0},
  {p:"F", grp:"F1", n:"Peony", i:"Parfum", c:85.6},
  {p:"F", grp:"F1", n:"Gardenia", i:"Parfum", c:230.0},

  {p:"F", grp:"F2", n:"Peach", i:"Parfum", c:321.0},
  {p:"F", grp:"F2", n:"Mixed Berry", i:"Parfum", c:695.0},
  {p:"F", grp:"F2", n:"Apple", i:"Parfum", c:900.0},
  {p:"F", grp:"F2", n:"Melon", i:"Parfum", c:267.5},
  {p:"F", grp:"F2", n:"Grapefruit", i:"Parfum", c:895.0},

  {p:"F", grp:"F3", n:"Sandalwood", i:"Parfum", c:480.0},
  {p:"F", grp:"F3", n:"Cedarwood", i:"Parfum", c:1595.0},
  {p:"F", grp:"F3", n:"Vetiver", i:"Parfum", c:775.0},
  {p:"F", grp:"F3", n:"Agarwood (Oud)", i:"Parfum", c:2198.0},
  {p:"F", grp:"F3", n:"Tobacco", i:"Parfum", c:2489.0},

  {p:"F", grp:"F4", n:"Ocean", i:"Parfum", c:2489.0},
  {p:"F", grp:"F4", n:"Green Tea", i:"Parfum", c:950.0},
  {p:"F", grp:"F4", n:"Cotton", i:"Parfum", c:2289.0},
  {p:"F", grp:"F4", n:"Mint", i:"Parfum", c:62.0},
  {p:"F", grp:"F4", n:"Eucalyptus", i:"Parfum", c:1995.0},

  {p:"F", grp:"F5", n:"Vanilla", i:"Parfum", c:660.0},
  {p:"F", grp:"F5", n:"Coconut", i:"Parfum", c:125.0},
  {p:"F", grp:"F5", n:"Coffee", i:"Parfum", c:950.0},
  {p:"F", grp:"F5", n:"Caramel", i:"Parfum", c:930.0},
  {p:"F", grp:"F5", n:"Chocolate", i:"Parfum", c:980.0},

  {p:"F", grp:"F6", n:"Linalool",          i:"Linalool",          c:1995.00, k:"Fresh Floral Wood",    note:"กลิ่นดอกไม้สดชื่น/ไม้",      a:"Linalool"},
  {p:"F", grp:"F6", n:"Limonene",          i:"Limonene",          c:7.00,    k:"Citrus Burst",         note:"กลิ่นส้ม/มะนาว/ผลไม้",        a:"Limonene"},
  {p:"F", grp:"F6", n:"Citronellol",       i:"Citronellol",       c:165.00,  k:"Rose Essence",         note:"กลิ่นกุหลาบ/ตะไคร้",          a:"Citronellol"},
  {p:"F", grp:"F6", n:"Geraniol",          i:"Geraniol",          c:1600.00, k:"Sweet Rose",           note:"กลิ่นกุหลาบหวาน",              a:"Geraniol"},
  {p:"F", grp:"F6", n:"Coumarin",          i:"Coumarin",          c:267.50,  k:"Warm Vanilla",         note:"กลิ่นวานิลลา/ถั่ว/หวาน",        a:"Coumarin"},
  {p:"F", grp:"F6", n:"Citral",            i:"Citral",            c:62.00,   k:"Zesty Lemon",          note:"กลิ่นเลมอนเข้มข้น",             a:"Citral"},
  {p:"F", grp:"F6", n:"Benzyl Salicylate", i:"Benzyl Salicylate", c:3740.00, k:"Soft Floral Fixative",  note:"ตรึงกลิ่น/ดอกไม้บางๆ",           a:"Benzyl Salicylate"},
  {p:"F", grp:"F6", n:"Hexyl Cinnamal",    i:"Hexyl Cinnamal",    c:1695.00, k:"Jasmine Breeze",      note:"กลิ่นมะลิ/คาโมมายล์",           a:"Hexyl Cinnamal"},
  {p:"F", grp:"F6", n:"Eugenol",           i:"Eugenol",           c:5885.00, k:"Spicy Wood",          note:"กลิ่นเครื่องเทศ/ไม้",           a:"Eugenol"},
  {p:"F", grp:"F6", n:"Benzyl Benzoate",   i:"Benzyl Benzoate",   c:225.00,  k:"Deep Scent Fixative", note:"ตัวตรึงกลิ่น (กลิ่นหนัก)",        a:"Benzyl Benzoate"},

  {p:"G", n:"BHT",   i:"BHT", c:150.0},
  {p:"G", n:"Vit E", i:"Tocopheryl Acetate", c:900.0}
]; // ======================
// RULES / CAPS / PRESETS
// ======================

// เพดานต่อพาร์ท (ผู้ใช้พิมพ์เกินได้ แต่ขึ้นเตือนแดง)
const capByPart = { C:10, D:5, F:10, E:1 };

// Part G fixed ทุกสูตร (รวม = 0.5%)
const fixedG = { BHT:0.1, TocopherylAcetate:0.4 };

// A/B เป็น FIXED โดย type (preset)
const presetABByType = {
  PARFUME_MAX: {
    A: { total: 60.0, items: { "Light White Oil": 60.0 } },
    B: { total: 27.0, items: { "C12-15 Alkyl Benzoate": 15.0, "IPM": 10.0, "Triethyl Citrate": 2.0 } }
  },
  GLOW_DEW: {
    A: { total: 55.5, items: { "Rice Bran Oil (Refine)": 35.0, "Sunflower Oil (Refine)": 12.0, "Soybean Oil (Refine)": 8.5 } },
    B: { total: 25.0, items: { "Ethylhexyl Palmitate": 15.0, "C12-15 Alkyl Benzoate": 7.0, "Isoamyl Laurate": 3.0 } }
  },
  DRY_TOUCH: {
    A: { total: 25.3, items: { "Rice Bran Oil (Refine)": 15.0, "Soybean Oil (Refine)": 10.3 } },
    B: { total: 62.0, items: { "Isoamyl Laurate": 25.0, "C12-15 Alkyl Benzoate": 20.0, "Ethylhexyl Palmitate": 12.0, "IPM": 5.0 } }
  },
  THERAPY: {
    A: { total: 68.5, items: { "Soybean Oil (Refine)": 30.0, "Rice Bran Oil (Refine)": 25.0, "Sunflower Oil (Refine)": 13.5 } },
    B: { total: 15.0, items: { "Ethylhexyl Palmitate": 8.0, "IPM": 4.0, "Triethyl Citrate": 3.0 } }
  },
  SUN_OIL: {
    A: { total: 55.0, items: { "Soybean Oil (Refine)": 55.0 } },
    B: { total: 32.5, items: { "C12-15 Alkyl Benzoate": 15.0, "Ethylhexyl Palmitate": 10.0, "IPM": 5.0, "Triethyl Citrate": 2.5 } }
  }
};

// จำกัดสิทธิ์เลือกวัตถุดิบตาม type
const allowedByType = {
  PARFUME_MAX: { allowA: ["Light White Oil","Medium White Oil"] }, // mineral only
  SUN_OIL: { allowA: ["Soybean Oil (Refine)"] }                     // soy only
};

// ======================
// Sync POOL targets to NEW formula structure
// A/B must follow presetABByType totals, G fixed = 0.5% (BHT 0.1 + VitE 0.4)
// Remaining % is distributed to C/D/E/F using each pool's original weights,
// but clamped by capByPart (C<=10, D<=5, E<=1, F<=10).
// ======================
function syncPoolTargetsToPresets() {
  const parts = ["C", "D", "E", "F"];

  function clampTargetsWithCaps(weights, totalToDistribute) {
    // initial proportional allocation
    const sumW = parts.reduce((a, p) => a + (Number(weights[p]) || 0), 0) || 1;
    const target = {};

    parts.forEach(p => {
      target[p] = (Number(weights[p]) || 0) / sumW * totalToDistribute;
    });

    // water-fill with caps
    const cap = {
      C: Number(capByPart?.C ?? 10),
      D: Number(capByPart?.D ?? 5),
      E: Number(capByPart?.E ?? 1),
      F: Number(capByPart?.F ?? 10)
    };

    // clamp once
    parts.forEach(p => {
      target[p] = Math.min(target[p], cap[p]);
    });

    // redistribute leftover to parts not at cap
    let used = parts.reduce((a, p) => a + target[p], 0);
    let leftover = totalToDistribute - used;

    // iterate a few rounds to settle
    for (let iter = 0; iter < 6 && leftover > 1e-9; iter++) {
      const open = parts.filter(p => target[p] < cap[p] - 1e-9);
      if (!open.length) break;

      const sumOpenW = open.reduce((a, p) => a + (Number(weights[p]) || 0), 0) || open.length;

      let addedThisRound = 0;
      open.forEach(p => {
        const w = (Number(weights[p]) || 0) || 1;
        const add = leftover * (w / sumOpenW);
        const room = cap[p] - target[p];
        const give = Math.min(add, room);
        target[p] += give;
        addedThisRound += give;
      });

      used = parts.reduce((a, p) => a + target[p], 0);
      leftover = totalToDistribute - used;
      if (addedThisRound < 1e-9) break;
    }

    // final rounding safety (keep sums stable)
    parts.forEach(p => {
      target[p] = Math.max(0, target[p]);
    });

    return target;
  }

  Object.keys(POOLS).forEach(key => {
    const pool = POOLS[key];
    const preset = presetABByType[key];
    if (!pool || !pool.ratios || !preset) return;

    const A_total = Number(preset?.A?.total ?? 0);
    const B_total = Number(preset?.B?.total ?? 0);
    const G_total = Number(fixedG?.BHT ?? 0) + Number(fixedG?.TocopherylAcetate ?? 0); // = 0.5

    // remaining to allocate to C/D/E/F
    const remaining = Math.max(0, 100 - A_total - B_total - G_total);

    // use original pool ratios as weights for C/D/E/F
    const weights = {
      C: Number(pool.ratios.C ?? 0),
      D: Number(pool.ratios.D ?? 0),
      E: Number(pool.ratios.E ?? 0),
      F: Number(pool.ratios.F ?? 0)
    };

    const t = clampTargetsWithCaps(weights, remaining);

    // write back synced targets
    pool.ratios.A = A_total;
    pool.ratios.B = B_total;
    pool.ratios.C = t.C;
    pool.ratios.D = t.D;
    pool.ratios.E = t.E;
    pool.ratios.F = t.F;
    pool.ratios.G = G_total;
  });
}

// Run once on load so dropdown + targets always match the new presets
syncPoolTargetsToPresets();

// ---------- helpers ----------
function findIdxByName(name){
  return MASTER_DB.findIndex(x => String(x.n).trim() === String(name).trim());
}

function setCheckedPct(idx, checked, value, lock=false){
  const chk = document.getElementById(`chk-${idx}`);
  const pct = document.getElementById(`pct-${idx}`);
  if(!chk || !pct) return;

  chk.checked = !!checked;
  pct.disabled = !chk.checked;
  pct.value = (Number(value)||0).toFixed(2);

  chk.disabled = !!lock;
  pct.readOnly = !!lock;
  pct.style.opacity = lock ? 0.7 : 1;
}

function applyAllowed(poolKey){
  const rule = allowedByType[poolKey];
  // reset
  MASTER_DB.forEach((it, idx)=>{
    if(it.p !== 'A') return;
    const chk = document.getElementById(`chk-${idx}`);
    if(chk) chk.disabled = false;
  });
  if(!rule?.allowA) return;

  const allowed = new Set(rule.allowA);
  MASTER_DB.forEach((it, idx)=>{
    if(it.p !== 'A') return;
    const chk = document.getElementById(`chk-${idx}`);
    const pct = document.getElementById(`pct-${idx}`);
    if(!chk || !pct) return;

    const ok = allowed.has(it.n);
    chk.disabled = !ok;
    if(!ok){
      chk.checked = false;
      pct.value = "0.00";
      pct.disabled = true;
      pct.readOnly = false;
      pct.style.opacity = 1;
    }
  });
}

function applyPresetAB(poolKey){
  const preset = presetABByType[poolKey];
  if(!preset) return;

  // clear A/B first
  MASTER_DB.forEach((it, idx)=>{
    if(it.p !== 'A' && it.p !== 'B') return;
    const chk = document.getElementById(`chk-${idx}`);
    const pct = document.getElementById(`pct-${idx}`);
    if(!chk || !pct) return;
    chk.checked = false;
    chk.disabled = false;
    pct.value = "0.00";
    pct.disabled = true;
    pct.readOnly = false;
    pct.style.opacity = 1;
  });

  // apply locked A
  Object.entries(preset.A.items||{}).forEach(([name,val])=>{
    const idx = findIdxByName(name);
    if(idx>=0) setCheckedPct(idx, true, val, true);
  });

  // apply locked B
  Object.entries(preset.B.items||{}).forEach(([name,val])=>{
    const idx = findIdxByName(name);
    if(idx>=0) setCheckedPct(idx, true, val, true);
  });
}

function applyFixedG(){
  const bhtIdx = findIdxByName("BHT");
  if(bhtIdx>=0) setCheckedPct(bhtIdx, true, fixedG.BHT, true);

  const vitEIdx = findIdxByName("Vit E");
  if(vitEIdx>=0) setCheckedPct(vitEIdx, true, fixedG.TocopherylAcetate, true);
}

function applyPoolConfig(){
  const poolKey = document.getElementById("selPool").value;
  applyAllowed(poolKey);
  applyPresetAB(poolKey);
  applyFixedG();
}

// --- Group meta (what C1/C2 etc. mean) ---
const GROUP_META = {
  C: {
    C1: { title: "Radiant / Light", desc: "ใส โกลว์ เบา (antioxidant/brightening)" },
    C2: { title: "Deep Nourish",    desc: "บำรุงลึก ชุ่มแน่น (barrier/repair feel)" }
  },
  D: {
    D1: { title: "Brighten / Calm", desc: "Vit/soothing/clarifying actives" },
    D2: { title: "Repair / Age",    desc: "barrier/anti-age/renew" },
    D3: { title: "UV Filters",      desc: "สารกันแดด (สำหรับ Sunscreen Oil)" }
  },
  E: {
    E1: { title: "Mica / Shimmer",  desc: "วิ้ง/ประกาย" },
    E2: { title: "Color",          desc: "สี (CI/ Lake)" }
  },
  F: {
    F1: { title: "Floral",         desc: "โทนดอกไม้" },
    F2: { title: "Fruity",         desc: "โทนผลไม้" },
    F3: { title: "Woody",          desc: "โทนไม้/เข้ม" },
    F4: { title: "Fresh",          desc: "โทนสะอาด/สดชื่น" },
    F5: { title: "Gourmand",       desc: "โทนหวาน/ของกิน" },
    F6: { title: "Allergens",      desc: "สารก่อภูมิแพ้/ตรึงกลิ่น" }
  }
};

function groupLabel(part, grp) {
  const m = GROUP_META?.[part]?.[grp];
  if (!m) return grp;
  return `${grp} • ${m.title}`;
}

function groupDesc(part, grp) {
  const m = GROUP_META?.[part]?.[grp];
  return m?.desc || "";
}

function buildGroupLegendHtml(part) {
  const meta = GROUP_META?.[part];
  if (!meta) return "";
  const keys = Object.keys(meta);
  return `
    <div class="group-legend">
      ${keys.map(k => `<span class="pill">${k}: ${meta[k].title}</span>`).join("")}
      <div style="margin-top:4px; color:#666;">${keys.map(k => `${k} = ${meta[k].desc}`).join(" | ")}</div>
    </div>
  `;
}

// --- Typing helpers ---
function sanitizePctValue(v) {
  let s = String(v ?? "");
  s = s.replace(/\u00A0/g, " ");
  s = s.replace(/[^0-9.]/g, "");

  const firstDot = s.indexOf('.');
  if (firstDot !== -1) {
    s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
  }

  if (s.startsWith('.')) s = '0' + s;
  return s;
}

function sanitizePctInput(idx) {
  const el = document.getElementById(`pct-${idx}`);
  if (!el) return;
  el.value = sanitizePctValue(el.value);
}

function onPctBlur(part, editedIdx = null) {
  updateAll();
}

// --- Mobile view switcher ---
function showView(which) {
  document.body.setAttribute('data-view', which);

  const b1 = document.getElementById('btnBuilder');
  const b2 = document.getElementById('btnPreview');
  if (b1 && b2) {
    b1.classList.toggle('active', which === 'builder');
    b2.classList.toggle('active', which === 'preview');
  }

  updateAll();
}

// --- QR (create once) ---
let QR = null;

// QS for a single part: เติมส่วนที่ขาดให้ตัวที่ % มากที่สุดในพาร์ทนั้น
function qsPart(part) {
  const poolKey = document.getElementById('selPool').value;
  const pool = POOLS[poolKey];
  const target = Number(pool?.ratios?.[part] ?? 0);
  if (!(target > 0)) return;

  const chosen = MASTER_DB
    .map((it, i) => ({ it, i }))
    .filter(x => x.it.p === part)
    .map(x => x.i)
    .filter(i => document.getElementById(`chk-${i}`)?.checked);

  if (!chosen.length) return;

  const vals = chosen.map(i => ({
    i,
    v: Math.max(0, parseFloat(document.getElementById(`pct-${i}`)?.value) || 0)
  }));

  const sum = vals.reduce((a,b) => a + b.v, 0);
  const remain = target - sum;
  if (remain <= 0) { updateAll(); return; }

  vals.sort((a,b) => b.v - a.v);
  const pick = vals[0].v > 0 ? vals[0].i : chosen[0];

  const el = document.getElementById(`pct-${pick}`);
  if (el) el.value = (Math.max(0, (parseFloat(el.value) || 0) + remain)).toFixed(2);

  updateAll();
}

// QS → 100%: เติมส่วนที่ขาดของ “ทั้งสูตร” ลง Base หลัก (Part A ที่ % มากที่สุด)
function qsTo100() {
  const poolKey = document.getElementById('selPool').value;
  const pool = POOLS[poolKey];
  if (!pool) return;

  const fixedGTotal = Number(pool?.ratios?.G ?? 0);

  let total = 0;
  MASTER_DB.forEach((it, idx) => {
    const checked = document.getElementById(`chk-${idx}`)?.checked || it.p === 'G';
    if (!checked) return;

    const el = document.getElementById(`pct-${idx}`);
    const v = Math.max(0, parseFloat(el?.value) || (it.p === 'G' ? fixedGTotal : 0));
    total += v;
  });

  const remain = 100 - total;
  if (remain <= 0) { updateAll(); return; }

  const chosenA = MASTER_DB
    .map((it, i) => ({ it, i }))
    .filter(x => x.it.p === 'A')
    .map(x => x.i)
    .filter(i => document.getElementById(`chk-${i}`)?.checked);

  if (!chosenA.length) { updateAll(); return; }

  let best = chosenA[0];
  let bestV = Math.max(0, parseFloat(document.getElementById(`pct-${best}`)?.value) || 0);
  for (const i of chosenA) {
    const v = Math.max(0, parseFloat(document.getElementById(`pct-${i}`)?.value) || 0);
    if (v > bestV) { bestV = v; best = i; }
  }

  const el = document.getElementById(`pct-${best}`);
  if (el) el.value = (bestV + remain).toFixed(2);

  updateAll();
}

function init() {
  const sel = document.getElementById('selPool');
  for (let k in POOLS) sel.add(new Option(POOLS[k].name, k));
  sel.value = Object.keys(POOLS)[0];

  document.getElementById('lblBatch').innerText = "#UB-" + Math.floor(Math.random()*900+100);

  QR = new QRious({
    element: document.getElementById('qr'),
    value: 'https://linktr.ee/unpun',
    size: 100
  });

  renderInterface();
  applyPoolConfig();
  updateAll();

  // Default view: builder (มือถือก็ต้องสร้างสูตรก่อน ไม่ใช่ไปมองฉลากเฉยๆ)
  document.body.setAttribute('data-view', 'builder');
  if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches) {
    showView('builder');
  } else {
    const b1 = document.getElementById('btnBuilder');
    const b2 = document.getElementById('btnPreview');
    if (b1 && b2) { b1.classList.add('active'); b2.classList.remove('active'); }
  }
}

function renderInterface() {
  const pool = POOLS[document.getElementById('selPool').value];
  const container = document.getElementById('ingredient-lists');
  container.innerHTML = "";

  ["A", "B", "C", "D", "F", "E"].forEach(type => {
    if ((pool?.ratios?.[type] ?? 0) >= 0) {
      const box = document.createElement('div');
      box.className = 'section-box';
      box.innerHTML = `
        <div class="section-title">
          <span>Part ${type} (Target ${Number(pool?.ratios?.[type] ?? 0).toFixed(2)}%)</span>
          <button class="qs-btn" onclick="qsPart('${type}'); return false;">QS</button>
        </div>
        <div class="part-warning" id="warn-${type}"></div>
        ${buildGroupLegendHtml(type)}
        <div id="list-${type}"></div>
      `;
      container.appendChild(box);

      const listDiv = document.getElementById(`list-${type}`);

      const items = MASTER_DB.filter(x => x.p === type);

      const hasGroups = items.some(x => x.grp) || Boolean(GROUP_META?.[type]);

      if (!hasGroups) {
        items.forEach(item => {
          const gIdx = MASTER_DB.indexOf(item);
          const row = document.createElement('div');
          row.className = 'item-row';
          row.innerHTML = `
            <input type="checkbox" id="chk-${gIdx}" data-idx="${gIdx}" onchange="toggleIn(${gIdx})" />
            <div style="flex:1">
              <div>${item.n}</div>
              <div style="font-size:0.75em; color:#666; line-height:1.2;">${(item.note ? item.note : '')}</div>
            </div>
            <input type="text" inputmode="decimal" id="pct-${gIdx}" value="0" class="item-pct" disabled
                   onfocus="this.select()"
                   oninput="sanitizePctInput(${gIdx}); updateAll()"
                   onblur="onPctBlur('${type}', ${gIdx})" /> %
          `;
          listDiv.appendChild(row);
        });
        return;
      }

      const grouped = {};
      items.forEach(item => {
        const g = item.grp || 'OTHER';
        if (!grouped[g]) grouped[g] = [];
        grouped[g].push(item);
      });

      const groupOrder = Object.keys(grouped).sort((a,b) => {
        const na = parseInt(a.replace(/\D/g,''),10);
        const nb = parseInt(b.replace(/\D/g,''),10);
        if (Number.isFinite(na) && Number.isFinite(nb) && a[0] === b[0]) return na - nb;
        return a.localeCompare(b);
      });

      groupOrder.forEach(grpKey => {
        const wrap = document.createElement('div');
        wrap.className = 'subgroup';

        const head = document.createElement('div');
        head.className = 'subgroup-head';
        head.innerHTML = `${groupLabel(type, grpKey)} <small>${groupDesc(type, grpKey)}</small>`;
        wrap.appendChild(head);

        grouped[grpKey].forEach(item => {
          const gIdx = MASTER_DB.indexOf(item);
          const row = document.createElement('div');
          row.className = 'item-row';
          row.innerHTML = `
            <input type="checkbox" id="chk-${gIdx}" data-idx="${gIdx}" onchange="toggleIn(${gIdx})" />
            <div style="flex:1">
              <div>${item.n}</div>
              <div style="font-size:0.75em; color:#666; line-height:1.2;">
                ${(item.grp ? item.grp : '')}${(item.k ? (item.grp ? ' • ' : '') + item.k : '')}${(item.note ? ' • ' + item.note : '')}
              </div>
            </div>
            <input type="text" inputmode="decimal" id="pct-${gIdx}" value="0" class="item-pct" disabled
                   onfocus="this.select()"
                   oninput="sanitizePctInput(${gIdx}); updateAll()"
                   onblur="onPctBlur('${type}', ${gIdx})" /> %
          `;
          wrap.appendChild(row);
        });

        listDiv.appendChild(wrap);
      });
    }
  });
}

function toggleIn(idx) {
  const chk = document.getElementById(`chk-${idx}`);
  if (!chk || chk.disabled) return;
  const pct = document.getElementById(`pct-${idx}`);
  const part = MASTER_DB[idx].p;

  pct.disabled = !chk.checked;

  if (!chk.checked) {
    pct.value = 0;
    updateAll();
    return;
  }

  pct.focus();
  pct.select();

  const poolKey = document.getElementById('selPool').value;
  const pool = POOLS[poolKey];
  const target = Number(pool?.ratios?.[part] ?? 0);

  const chosen = MASTER_DB
    .map((it, i) => ({ it, i }))
    .filter(x => x.it.p === part)
    .map(x => x.i)
    .filter(i => document.getElementById(`chk-${i}`)?.checked);

  const sumChosen = chosen.reduce((acc, i) => acc + (parseFloat(document.getElementById(`pct-${i}`)?.value) || 0), 0);

  if (target > 0 && (sumChosen <= 0 || chosen.length === 1)) {
    pct.value = target.toFixed(2);
  }

  updateAll();
}

function updateAll() {
  const poolKey = document.getElementById('selPool').value;
  const pool = POOLS[poolKey];
  if (!pool) return;

  function escHtml(s) {
    return String(s || "")
      .replace(/\u00A0/g, " ")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function formatInciLinesHtml(items, perLine = 4) {
    const out = [];
    for (let i = 0; i < items.length; i += perLine) {
      out.push(items.slice(i, i + perLine).map(escHtml).join(", "));
    }
    return out.join("<br>");
  }

  let selected = [];
  let totalCost = 0;
  let inciList = [];
  let allergies = [];
  const partSums = { A:0, B:0, C:0, D:0, E:0, F:0, G:0 };

  MASTER_DB.forEach((item, idx) => {
    const isChecked = document.getElementById(`chk-${idx}`)?.checked || item.p === 'G';

    // Part G fixed value per item (รวม 0.5%)
    const gFixedVal = (item.p === 'G')
      ? (item.n === 'BHT' ? fixedG.BHT : (item.n === 'Vit E' ? fixedG.TocopherylAcetate : 0))
      : 0;

    const el = document.getElementById(`pct-${idx}`);
    const raw = parseFloat(el?.value);
    const val = Number.isFinite(raw) ? raw : gFixedVal;

    if (isChecked && val > 0) {
      totalCost += (item.c * val / 100);
      selected.push({ ...item, qty: val });
      if (partSums[item.p] != null) partSums[item.p] += val;

      if (item.i) inciList.push(item.i);
      if (item.a) {
        item.a.split(",").map(s => s.trim()).filter(Boolean).forEach(x => allergies.push(x));
      }
    }
  }); // cap warning (C/D/E/F)
Object.entries(capByPart).forEach(([part, cap])=>{
  const warnEl = document.getElementById(`warn-${part}`);
  if(!warnEl) return;

  const sum = Number(partSums[part] ?? 0);
  warnEl.classList.remove("over","under");
  warnEl.style.display = "none";

  if(sum > cap + 0.001){
    warnEl.classList.add("over");
    warnEl.style.display = "block";
    warnEl.innerText = `⚠ เกินเพดาน Part ${part}: Cap ${cap.toFixed(2)}% แต่ตอนนี้ ${sum.toFixed(2)}% (เกิน ${(sum-cap).toFixed(2)}%)`;
  }
});

  document.getElementById('totalCost').innerText = Math.round(totalCost).toLocaleString();
  document.getElementById('lblCostVal').innerText = Math.round(totalCost).toLocaleString();
  document.getElementById('lblDev').innerText = document.getElementById('custName').value;

  const scent = selected.find(x => x.p === "F")?.n || "Natural";
  const key = selected.find(x => x.p === "C" || x.p === "D")?.k || "";
  document.getElementById('lblTitle').innerText = `${scent} ${key} ${pool.name}`.toUpperCase();

  const hero = selected
    .filter(x => ["C","D"].includes(x.p))
    .map(x => ({ ...x, score: (Number(x.c) || 0) * (Number(x.qty) || 0) }))
    .sort((a, b) => b.score - a.score);

  document.getElementById('lblHero').innerHTML = hero.slice(0, 3)
    .map(x => `<div class="lbl-hero-item"><span>• ${escHtml(x.n)}</span> <span>${Number(x.qty).toFixed(2)}%</span></div>`)
    .join("");

  const inciClean = inciList
    .map(s => String(s || "").replace(/\s+/g, " ").trim())
    .filter(Boolean);

  const inciUnique = [...new Set(inciClean)];
  const inciBody = formatInciLinesHtml(inciUnique, 4);
  document.getElementById('lblInci').innerHTML = "Ingredients:<br>" + inciBody + ".";

  const allUnique = [...new Set(allergies)];
  document.getElementById('lblAllergy').innerText = "*Allergens: " + (allUnique.length ? allUnique.join(", ") : "None");

  ["A","B","C","D","E","F","G"].forEach(part => {
    const warnEl = document.getElementById(`warn-${part}`);
    if (!warnEl) return;

    const target = Number(pool?.ratios?.[part] ?? 0);
    const sum = Number(partSums[part] ?? 0);

    warnEl.classList.remove('over','under');
    warnEl.style.display = 'none';

    if (!(target > 0)) return;

    const diff = sum - target;
    const abs = Math.abs(diff);
    if (abs < 0.01) return;

    if (diff > 0) {
      warnEl.classList.add('over');
      warnEl.style.display = 'block';
      warnEl.innerText = `⚠ เกินกำหนด: Target ${target.toFixed(2)}% แต่ตอนนี้ ${sum.toFixed(2)}% (เกิน ${abs.toFixed(2)}%)`;
    } else {
      warnEl.classList.add('under');
      warnEl.style.display = 'block';
      warnEl.innerText = `ยังไม่ครบ: Target ${target.toFixed(2)}% แต่ตอนนี้ ${sum.toFixed(2)}% (ขาด ${abs.toFixed(2)}%) • กด QS เพื่อเติมให้ครบ`;
    }
  });

  // QR code value is now fixed; do not update dynamically
}

window.addEventListener('resize', () => {
  if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches) {
    const cur = document.body.getAttribute('data-view');
    if (!cur) showView('builder');
  } else {
    document.body.setAttribute('data-view', 'builder');
    const b1 = document.getElementById('btnBuilder');
    const b2 = document.getElementById('btnPreview');
    if (b1 && b2) { b1.classList.add('active'); b2.classList.remove('active'); }
  }
});

init();
</script>
</body>
</html>